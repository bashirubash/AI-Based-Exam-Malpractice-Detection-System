{% extends 'base.html' %}
{% block content %}

<div class="container">
  <h4 class="mb-4">Student Identity Verification</h4>

  <form method="POST" enctype="multipart/form-data" action="{{ url_for('verify_student') }}">
    <div class="mb-3">
      <label for="webcam" class="form-label">Webcam Preview</label><br>
      <video id="video" width="480" height="360" autoplay></video>
      <canvas id="canvas" width="480" height="360" style="display: none;"></canvas>
    </div>

    <input type="hidden" name="image_data" id="image_data">

    <button type="button" class="btn btn-primary" onclick="capture()">Capture Face</button>
    <button type="submit" class="btn btn-success">Verify Student</button>
  </form>

  <div class="alert alert-warning mt-4" id="speechAlert" style="display: none;">
    Unauthorized speech detected!
  </div>
</div>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const image_data = document.getElementById('image_data');
  const speechAlert = document.getElementById('speechAlert');

  // Webcam access
  navigator.mediaDevices.getUserMedia({ video: true })
    .then((stream) => {
      video.srcObject = stream;
    })
    .catch((err) => {
      console.error("Error accessing webcam: ", err);
    });

  function capture() {
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    let dataURL = canvas.toDataURL('image/png');
    image_data.value = dataURL;
    alert('Face captured successfully!');
  }

  // Speech detection using Web Speech API
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const transcript = event.results[event.resultIndex][0].transcript;
      console.log("Speech detected: ", transcript);
      if (transcript.trim().length > 3) {
        speechAlert.style.display = 'block';
        // Optionally send an alert to the server (AJAX)
      }
    };

    recognition.onerror = (event) => {
      console.error("Speech recognition error:", event.error);
    };

    recognition.start();
  } else {
    console.warn("Speech Recognition not supported in this browser.");
  }
</script>

{% endblock %}
